# Mobile Navbar

type: vertical-stack
cards:

  # Phone Portrait
  - type: conditional
    conditions:
      - condition: state
        entity: input_boolean.hemma_mobile_navigation
        state: "off"
      - condition: screen
        media_query: "(orientation: portrait) and (max-width: 767px)"

    card:
      type: custom:navbar-card

      desktop:
        min_width: 99999
        hidden: true
        show_labels: false

      mobile:
        mode: docked
        show_labels: true
        hidden: >
          [[[
            const mm = (q) => (window.matchMedia ? window.matchMedia(q).matches : false);
            const isTouch = mm('(pointer: coarse)') || mm('(hover: none)');
            return !isTouch;
          ]]]

      layout:
        auto_padding:
          enabled: false
          desktop_px: 0
          mobile_px: 0

      card_mod:
        style: |
          :host{ z-index: 2147483647 !important; }
          ha-card{
            --mdc-ripple-press-opacity: 0 !important;
            background: transparent !important;
            box-shadow: none !important;
            overflow: visible !important;
            padding: 0 !important;
          }

      styles: |
        .navbar-card.desktop{ display:none !important; }

        .navbar-card.mobile,
        ha-card.navbar-card.mobile{
          position: fixed !important;
          left: 50% !important;
          transform: translateX(-50%) !important;
          bottom: 22px !important;
          top: auto !important;
          width: min(280px, calc(100vw - 38px)) !important;
          max-width: 350px !important;
          padding: 2px !important;
          border-radius: 9999px !important;
          background: var(--hemma-nav-bg, rgba(255,255,255,0.10)) !important;
          -webkit-backdrop-filter: blur(16px) saturate(180%) !important;
          backdrop-filter: blur(16px) saturate(110%) !important;
          border: 1px solid var(--hemma-nav-border, rgba(255,255,255,0.12)) !important;
          box-shadow: var(--hemma-nav-shadow, 0 22px 50px rgba(0,0,0,0.32)) !important;
          overflow: hidden !important;
          --navbar-primary-color: var(--hemma-nav-icon, rgba(255,255,255,.8)) !important;
          --navbar-active-color:  var(--hemma-nav-icon-active, rgba(255,255,255,1)) !important;
          --navbar-route-background: transparent !important;
          --navbar-route-active-background: transparent !important;
          --navbar-active-background: transparent !important;
          --navbar-route-active-color: inherit !important;
        }

        .navbar.mobile{
          display: flex !important;
          align-items: center !important;
          justify-content: space-between !important;
          width: 100% !important;
          gap: 0 !important;
          padding: 0 !important;
          margin: 0 !important;
          --navbar-route-icon-size: 28px !important;
        }

        .route{
          flex: 1 1 0 !important;
          min-width: 0 !important;
          height: 54px !important;
          border-radius: 9999px !important;
          padding: 1px !important;
          box-sizing: border-box !important;
          background: transparent !important;
          box-shadow: none !important;
          border: 0 !important;
          outline: 0 !important;
          overflow: hidden !important;
          margin: 0 !important;
          display: flex !important;
          flex-direction: column !important;
          align-items: center !important;
          justify-content: center !important;
          gap: 2px !important;
        }

        .route.active{
          background: var(--hemma-nav-active-fill, rgba(255,255,255,0.20)) !important;
          background-clip: content-box !important;
          box-shadow: none !important;
        }

        .button{
          width: 100% !important;
          height: auto !important;
          flex: 0 0 auto !important;
          display: flex !important;
          align-items: center !important;
          justify-content: center !important;
          background: transparent !important;
          border: 0 !important;
          box-shadow: none !important;
          margin: 0 !important;
          padding: 0 !important;
        }

        .navbar.mobile ha-icon{
          --mdc-icon-size: var(--navbar-route-icon-size) !important;
          width: var(--navbar-route-icon-size) !important;
          height: var(--navbar-route-icon-size) !important;
          display: inline-flex !important;
          align-items: center !important;
          justify-content: center !important;
          line-height: 1 !important;
          flex: 0 0 auto !important;
        }

        .icon, .image{
          transition: opacity .18s ease !important;
          margin: 0 !important;
          background: transparent !important;
          box-shadow: none !important;
        }
        .route.active .icon, .route.active .image,
        .icon.active, .image.active{
          opacity: 1 !important;
        }

        .route .label{
          display: block !important;
          flex: 0 0 auto !important;
          width: 100% !important;
          text-align: center !important;
          font-size: 11px !important;
          font-weight: 600 !important;
          line-height: 1 !important;
          white-space: nowrap !important;
          overflow: hidden !important;
          text-overflow: ellipsis !important;
          opacity: .78 !important;
          margin: 0 !important;
          padding: 0 !important;
        }
        .route.active .label{ opacity: 1 !important; }

        ha-ripple{ display:none !important; }
        .mdc-ripple-surface::before,
        .mdc-ripple-surface::after{
          content: none !important;
          display: none !important;
          opacity: 0 !important;
        }

        .navbar-popup{
          background: rgba(0,0,0,0.25) !important;
          -webkit-backdrop-filter: blur(10px) saturate(110%) !important;
          backdrop-filter: blur(10px) saturate(110%) !important;
          box-shadow: var(--button-card-box-shadow) !important;
          border-radius: 22px !important;
          padding: 12px !important;
          width: max-content !important;
          max-width: calc(100vw - 24px) !important;
          box-sizing: border-box !important;
          display: flex !important;
          flex-direction: column-reverse !important;
          align-items: flex-start !important;
          justify-content: flex-start !important;
          text-align: left !important;
          transition: all 0.22s cubic-bezier(.2,.8,.2,1) !important;
          --hemma-popup-label-size: 15px;
          --hemma-popup-label-weight: 400;
          --hemma-popup-label-active-weight: 550;
          --hemma-popup-label-inactive-opacity: .82;
        }

        .navbar-popup.open-up{
          margin-top: -8px !important;
        }

        .navbar-popup-backdrop.visible{
          opacity: 0 !important;
        }

        .navbar-popup.visible .popup-item{
          transition-delay: calc(var(--index) * 0.03s) !important;
        }

        .navbar-popup,
        .navbar-popup *{
          --mdc-theme-primary: rgba(255,255,255,0.92) !important;
          --mdc-theme-secondary: rgba(255,255,255,0.92) !important;
          --icon-primary-color: rgba(255,255,255,0.92) !important;
          --icon-secondary-color: rgba(255,255,255,0.92) !important;
        }

        .navbar-popup .popup-item{
          display: grid !important;
          grid-template-columns: 18px max-content !important;
          align-items: center !important;
          justify-items: start !important;
          column-gap: 9px !important;
          padding: 12px 12px 12px 8px !important;
          border-radius: 12px !important;
          width: 100% !important;
          color: rgba(255,255,255,0.92) !important;
          box-sizing: border-box !important;
          text-align: left !important;
        }

        .navbar-popup .popup-item:hover{ background: rgba(255,255,255,0.06) !important; }
        .navbar-popup .popup-item:active{ background: rgba(255,255,255,0.10) !important; }

        .navbar-popup .popup-item ha-icon{
          width: 18px !important;
          height: 18px !important;
          --mdc-icon-size: 18px !important;
          display: inline-flex !important;
          align-items: center !important;
          justify-content: center !important;
          line-height: 1 !important;
          color: rgba(255,255,255,0.92) !important;
          opacity: var(--hemma-popup-label-inactive-opacity) !important;
        }

        .navbar-popup .popup-item .label{
          font-size: var(--hemma-popup-label-size) !important;
          font-weight: var(--hemma-popup-label-weight) !important;
          line-height: 1.1 !important;
          margin: 0 !important;
          padding: 0 !important;
          color: rgba(255,255,255,0.92) !important;
          opacity: var(--hemma-popup-label-inactive-opacity) !important;
        }

        .navbar-popup .popup-item.active ha-icon,
        .navbar-popup .popup-item.active .label{
          opacity: 1 !important;
        }

        .navbar-popup .popup-item.active .label{
          font-weight: var(--hemma-popup-label-active-weight) !important;
        }

        .navbar-card, .navbar-card *{ box-sizing: border-box !important; }

      routes:
        # Home
        - url: /dashboard-hemma/home
          label: Home
          icon: mdi:home-variant
          icon_selected: mdi:home-variant

        # Rooms (Dropdown Menu)
        - label: Rooms
          icon: >
            [[[
              const p = window.location.pathname || '';
              if (p === '/dashboard-hemma/bedroom') return 'mdi:bed-king';
              if (p === '/dashboard-hemma/kitchen') return 'mdi:fridge';
              if (p === '/dashboard-hemma/living-room') return 'mdi:sofa';
              return 'mdi:sofa';
            ]]]
          icon_selected: >
            [[[
              const p = window.location.pathname || '';
              if (p === '/dashboard-hemma/bedroom') return 'mdi:bed-king';
              if (p === '/dashboard-hemma/kitchen') return 'mdi:fridge';
              if (p === '/dashboard-hemma/living-room') return 'mdi:sofa';
              return 'mdi:sofa';
            ]]]
          tap_action:
            action: open-popup
          selected: >
            [[[
              const p = window.location.pathname;
              return p.startsWith('/dashboard-hemma/')
                && !['/dashboard-hemma/home','/dashboard-hemma/scenes'].includes(p);
            ]]]
          popup:
            - label: Bedroom
              url: /dashboard-hemma/bedroom
              icon: mdi:bed-king
            - label: Kitchen
              url: /dashboard-hemma/kitchen
              icon: mdi:fridge
            - label: Living Room
              url: /dashboard-hemma/living-room
              icon: mdi:sofa

        # Scenes (Dropdown Menu)
        - label: Scenes
          icon: mdi:layers
          icon_selected: mdi:layers
          tap_action:
            action: open-popup
          popup: |
            [[[
              const reg = hass.entities;

              const getRegEntry = (id) => {
                if (!reg) return null;
                if (Array.isArray(reg)) return reg.find(e => e?.entity_id === id) || null;
                return reg[id] || (reg.get ? reg.get(id) : null) || null;
              };

              const isHidden = (id) => {
                const e = getRegEntry(id);
                // Different HA versions expose slightly different fields
                return !!(e && (e.hidden || e.hidden_by || e.disabled || e.disabled_by));
              };

              const scenes = Object.values(hass.states || {})
                .filter(e => e?.entity_id?.startsWith('scene.'))
                // Keep only scenes that are NOT hidden/disabled in HA
                .filter(s => !isHidden(s.entity_id))
                .slice()
                .sort((a,b) => (a.attributes?.friendly_name || a.entity_id)
                  .localeCompare(b.attributes?.friendly_name || b.entity_id));

              return scenes.map(s => ({
                label: s.attributes?.friendly_name || s.entity_id.replace('scene.',''),
                icon: s.attributes?.icon || 'mdi:layers',
                tap_action: {
                  action: 'call-service',
                  service: 'scene.turn_on',
                  service_data: { entity_id: s.entity_id }
                }
              }));
            ]]]

  # Landscape (Tablet only)
  - type: conditional
    conditions:
      - condition: state
        entity: input_boolean.hemma_mobile_navigation
        state: "off"
      - condition: screen
        media_query: "(orientation: landscape) and (min-width: 768px) and (max-width: 1400px)"

    card:
      type: custom:navbar-card

      desktop:
        min_width: 1
        hidden: false
        mode: floating
        position: top
        show_labels: true
        show_popup_label_backgrounds: false

      mobile:
        hidden: true

      layout:
        auto_padding:
          enabled: false
          desktop_px: 0
          mobile_px: 0

      card_mod:
        style: |
          :host{ z-index: 2147483647 !important; }
          ha-card{
            --mdc-ripple-press-opacity: 0 !important;
            background: transparent !important;
            box-shadow: none !important;
            overflow: visible !important;
            padding: 0 !important;
          }

      styles: |
        .navbar-card.mobile{ display:none !important; }

        ha-card.navbar-card.desktop{
          position: fixed !important;
          left: 50% !important;
          transform: translateX(-50%) !important;
          top: 22px !important;
          bottom: auto !important;
          width: fit-content !important;
          border-radius: 9999px !important;
          padding: 4px !important;
          background: var(--hemma-nav-bg, rgba(255,255,255,0.11)) !important;
          -webkit-backdrop-filter: blur(12px) !important;
          backdrop-filter: blur(12px) !important;
          border: 1px solid var(--hemma-nav-border, rgba(255,255,255,0.12)) !important;
          box-shadow: var(--hemma-nav-shadow, 0 18px 36px rgba(0,0,0,.04)) !important;
          overflow: visible !important;

          --navbar-primary-color: var(--hemma-nav-icon, rgba(255,255,255,.78)) !important;
          --navbar-active-color: var(--hemma-nav-icon-active, rgba(255,255,255,1)) !important;
          --navbar-route-active-background: transparent !important;
          --navbar-route-active-color: inherit !important;
        }

        .navbar.desktop{
          --navbar-route-icon-size: 0px !important;
          display:flex !important;
          gap: 5px !important;
          padding: 0 !important;
          margin: 0 !important;
        }

        .icon, .image{ display:none !important; }

        .route{
          flex: 1 1 0 !important;
          display:flex !important;
          align-items:center !important;
          justify-content:center !important;
          padding: 0 12px 0 12px !important;
          background: transparent !important;
          overflow: visible !important;
        }

        .button{
          width: 100% !important;
          height: 100% !important;
          display:flex !important;
          align-items:center !important;
          justify-content:center !important;
          background: transparent !important;
          border: none !important;
          box-shadow: none !important;
          overflow: visible !important;
        }

        .label{
          display:inline-flex !important;
          align-items:center !important;
          justify-content:center !important;
          padding: 12px !important;
          border-radius: 9999px !important;
          line-height: 1 !important;
          white-space: nowrap !important;
          overflow: hidden !important;
          text-overflow: ellipsis !important;
          font-size: 16px !important;
          font-weight: 600 !important;
          color: var(--navbar-primary-color) !important;
          opacity: var(--hemma-nav-inactive-opacity, .82) !important;
          background: transparent !important;
        }

        .route.active .label,
        .label.active{
          background: var(--hemma-nav-active-fill, rgba(255,255,255,0.22)) !important;
          box-shadow: none !important;
          color: var(--navbar-active-color) !important;
          opacity: 1 !important;
        }

        .navbar.desktop .route:nth-child(5) .label{
          gap: 6px !important;
        }
        .navbar.desktop .route:nth-child(5) .label::after{
          content: "\2304" !important;
          display: inline-flex !important;
          align-items: center !important;
          justify-content: center !important;
          line-height: 1 !important;
          font-weight: 800 !important;
          opacity: 0.8 !important;
          width: 16px !important;
          overflow: visible !important;
          transform: translateY(-2px) scaleY(1.05) scaleX(1.35) !important;
          transform-origin: center !important;
        }

        .navbar-card.desktop .route{
          height: auto !important;
          min-height: 0 !important;
          width: auto !important;
          min-width: 0 !important;
          margin: 0 !important;
        }

        .navbar-card.desktop .button{
          width: auto !important;
          height: auto !important;
          padding: 0 !important;
        }

        .navbar-card.desktop .label{
          line-height: 1 !important;
        }

        .navbar-card.desktop {
            gap: 5px !important;
        }

        .navbar-popup{
          background: rgba(0,0,0,0.25) !important;
          -webkit-backdrop-filter: blur(10px) saturate(110%) !important;
          backdrop-filter: blur(10px) saturate(110%) !important;
          box-shadow: var(--button-card-box-shadow) !important;
          border-radius: 22px !important;
          padding: 8px !important;
          width: max-content !important;
          max-width: calc(100vw - 24px) !important;
          box-sizing: border-box !important;
          display: flex !important;
          flex-direction: column !important;
          align-items: stretch !important;
          justify-content: flex-start !important;
          text-align: left !important;
          transition: all 0.22s cubic-bezier(.2,.8,.2,1) !important;

          --hemma-popup-label-size: 15px;
          --hemma-popup-label-weight: 400;
          --hemma-popup-label-active-weight: 550;
          --hemma-popup-label-inactive-opacity: .82;
        }

        .navbar-popup.open-bottom{
          margin-top: 10px !important;
        }

        .navbar-popup-backdrop{
          background: rgba(0,0,0,0.12) !important;
        }

        .navbar-popup-backdrop.visible{
          opacity: 0 !important;
        }

        .navbar-popup .popup-item{
          display: grid !important;
          grid-template-columns: 18px 1fr !important;
          align-items: center !important;
          justify-items: start !important;
          column-gap: 11px !important;
          padding: 10px 12px 10px 10px !important;
          border-radius: 16px !important;
          width: 100% !important;
          box-sizing: border-box !important;
          text-align: left !important;
          background: transparent !important;
        }

        .navbar-popup .popup-item:hover{ background: rgba(255,255,255,0.06) !important; }
        .navbar-popup .popup-item:active{ background: rgba(255,255,255,0.10) !important; }

        .navbar-popup .popup-item .button{
          width: auto !important;
          height: auto !important;
          background: transparent !important;
          box-shadow: none !important;
          border: 0 !important;
          border-radius: 0 !important;
          padding: 0 !important;
          margin: 0 !important;
          display: inline-flex !important;
          align-items: center !important;
          justify-content: center !important;
        }

        .navbar-popup .popup-item .button:hover,
        .navbar-popup .popup-item .button:active{
          background: transparent !important;
          box-shadow: none !important;
        }

        .navbar-popup ha-icon{
          width: 18px !important;
          height: 18px !important;
          --mdc-icon-size: 18px !important;
          display: inline-flex !important;
          align-items: center !important;
          justify-content: center !important;
          line-height: 1 !important;
          color: rgba(255,255,255,0.92) !important;
          opacity: var(--hemma-popup-label-inactive-opacity) !important;
          padding: 0 !important;
          margin: 0 !important;
        }

        .navbar-popup .label{
          font-size: var(--hemma-popup-label-size) !important;
          font-weight: var(--hemma-popup-label-weight) !important;
          line-height: 1.1 !important;
          margin: 0 !important;
          padding: 0 !important;
          color: rgba(255,255,255,0.92) !important;
          opacity: var(--hemma-popup-label-inactive-opacity) !important;
          background: transparent !important;
          width: 100% !important;
        }

        .navbar-popup :is(.popup-item.active ha-icon, .popup-item.active .label){
          opacity: 1 !important;
        }

        .navbar-popup .popup-item.active .label{
          font-weight: var(--hemma-popup-label-active-weight) !important;
        }

        .navbar-popup.visible .popup-item{
          transition-delay: calc(var(--index) * 0.02s) !important;
        }

        .navbar-popup ha-ripple{ display:none !important; }
        .navbar-popup .mdc-ripple-surface::before,
        .navbar-popup .mdc-ripple-surface::after{
          content: none !important;
          display: none !important;
          opacity: 0 !important;
        }

      routes:
        - url: /dashboard-hemma/home
          label: Home
          icon: mdi:home-variant

        - url: /dashboard-hemma/living-room
          label: Living Room
          icon: mdi:sofa

        - url: /dashboard-hemma/kitchen
          label: Kitchen
          icon: mdi:fridge

        - url: /dashboard-hemma/bedroom
          label: Bedroom
          icon: mdi:bed-king

        - label: Scenes
          icon: mdi:layers
          tap_action:
            action: open-popup
          popup: |
            [[[
              const reg = hass.entities;

              const getRegEntry = (id) => {
                if (!reg) return null;
                if (Array.isArray(reg)) return reg.find(e => e?.entity_id === id) || null;
                return reg[id] || (reg.get ? reg.get(id) : null) || null;
              };

              const isHidden = (id) => {
                const e = getRegEntry(id);
                return !!(e && (e.hidden || e.hidden_by || e.disabled || e.disabled_by));
              };

              const scenes = Object.values(hass.states || {})
                .filter(e => e?.entity_id?.startsWith('scene.'))
                .filter(s => !isHidden(s.entity_id))
                .slice()
                .sort((a,b) => (a.attributes?.friendly_name || a.entity_id)
                  .localeCompare(b.attributes?.friendly_name || b.entity_id));

              return scenes.map(s => ({
                label: s.attributes?.friendly_name || s.entity_id.replace('scene.',''),
                icon: s.attributes?.icon || 'mdi:layers',
                tap_action: {
                  action: 'call-service',
                  service: 'scene.turn_on',
                  service_data: { entity_id: s.entity_id }
                }
              }));
            ]]]
