hemma_thermostat:
  template: [hemma_entity]
  show_entity_picture: false
  show_icon: false
  show_label: false
  name: Thermostat

  variables:
    thermostat_toggle_helper: input_boolean.hemma_thermostat_overlay
    temp_sensor:

  state_display: |
    [[[
      const mode = entity.state;
      const target = entity.attributes.temperature;
      if (mode === 'cool') {
        return "Cooling to " + target + "°";
      } else if (mode === 'heat') {
        return "Heating to " + target + "°";
      } else {
        return "Off";
      }
    ]]]

  tap_action:
    action: call-service
    service: input_boolean.toggle
    service_data:
      entity_id: |
        [[[
          return variables.thermostat_toggle_helper;
        ]]]

  hold_action:
    action: more-info
    entity: '[[[ return entity.entity_id ]]]'

  custom_fields:
    temp_puck:
      card:
        type: custom:button-card
        entity: '[[[ return entity.entity_id ]]]'
        show_name: false
        show_icon: false
        show_state: false
        tap_action:
          action: more-info
        state_display: |
          [[[
            let raw;
            const eid = variables.temp_sensor;
            if (eid && states[eid] && !["unknown","unavailable"].includes(states[eid].state)) {
              raw = states[eid].state;
            } else {
              raw = entity?.attributes?.current_temperature;
            }
            const n = Math.round(Number(raw));
            if (raw == null || Number.isNaN(n)) return '';
            return `${n}`;
          ]]]
        custom_fields:
          temp_display: |
            [[[
              let raw;
              const eid = variables.temp_sensor;
              if (eid && states[eid] && !["unknown","unavailable"].includes(states[eid].state)) {
                raw = states[eid].state;
              } else {
                raw = entity?.attributes?.current_temperature;
              }
              const n = Math.round(Number(raw));
              if (raw == null || Number.isNaN(n)) return '';
              return `${n}`;
            ]]]
        styles:
          card:
            - background: |
                [[[
                  const s = String(entity?.state || '').toLowerCase();
                  const active = ["cool","heat"].includes(s);
                  return active
                    ? 'rgba(255,255,255,0.06)'
                    : 'rgba(255,255,255,0.02)';
                ]]]
            - border: 1.8px solid
            - border-color: |
                [[[
                  const s = String(entity?.state || '').toLowerCase();
                  const isActive = ["cool","heat"].includes(s);
                  const c = isActive
                    ? 'var(--hemma-entity-active, var(--primary-text-color))'
                    : 'var(--hemma-entity-inactive, var(--secondary-text-color))';
                  return `color-mix(in srgb, ${c} 55%, transparent)`;
                ]]]
            - border-radius: 50%
            - width: 100%
            - height: 100%
            - min-width: 0
            - min-height: 0
            - padding: 6px
            - margin: 0
            - box-shadow: none
            - opacity: 0.8
            - transition: opacity 0.2s ease, transform 0.15s ease, filter 0.2s ease
            - cursor: pointer
            - box-sizing: border-box
            - display: flex
            - align-items: center
            - justify-content: center
          name:
            - display: none
          custom_fields:
            temp_display:
              - display: flex
              - align-items: center
              - justify-content: center
              - width: 100%
              - height: 100%
              - color: |
                  [[[
                    const s = String(entity?.state || '').toLowerCase();
                    const isActive = ["cool","heat"].includes(s);
                    const c = isActive
                      ? 'var(--hemma-entity-active, var(--primary-text-color))'
                      : 'var(--hemma-entity-inactive, var(--secondary-text-color))';
                    return `color-mix(in srgb, ${c} 75%, transparent)`;
                  ]]]
              - font-weight: 500
              - line-height: 1
              - font-size: |
                  [[[
                    const isMobile = window.matchMedia('(max-width: 767px), (max-height: 600px)').matches;
                    return isMobile ? '12px' : '16px';
                  ]]]
              - letter-spacing: -0.5px
        extra_styles: |
          @media (hover: hover) {
            :host ha-card:hover {
              opacity: 1 !important;
              filter: brightness(1.2);
              transform: scale(1.05);
            }
          }
          @media (hover: none) {
            :host ha-card:active {
              opacity: 1 !important;
              filter: brightness(1.2);
              transform: scale(1.05);
            }
          }

    cooling_modes:
      card:
        type: custom:layout-card
        layout_type: custom:grid-layout
        layout:
          position: absolute
          inset: 0 0 0 auto
          width: var(--rail-w)
          grid-template-columns: 1fr
          grid-template-rows: repeat(2, 1fr)
          height: 100%
          margin: 0
          padding: 0
          align-items: stretch
          justify-items: stretch
        cards:

          - type: custom:button-card
            template: [hemma_default]
            show_entity_picture: true
            entity_picture: /local/hemma/icons/power_off.svg
            tap_action:
              action: call-service
              service: climate.set_hvac_mode
              data:
                entity_id: '[[[ return entity.entity_id ]]]'
                hvac_mode: "off"
            styles:
              card:
                - height: 100%
                - min-height: 0
                - padding: 0
                - box-shadow: none !important
                - background: |
                    [[[
                      return entity.state === 'off'
                        ? 'var(--hemma-control-on)'
                        : 'var(--hemma-control-off)';
                    ]]]
              img_cell: [ { width: '30%' } ]
              icon: [ { width: '100%' }, { height: '100%' } ]

          - type: custom:button-card
            template: [hemma_default]
            show_entity_picture: true
            entity_picture: |
              [[[
                const sel = states['input_select.hemma_thermostat_mode']?.state || 'cool';
                return sel === 'heat'
                  ? '/local/hemma/icons/heating.svg'
                  : '/local/hemma/icons/cooling.svg';
              ]]]

            tap_action:
              action: call-service
              service: climate.set_hvac_mode
              data:
                entity_id: '[[[ return entity.entity_id ]]]'
                hvac_mode: |
                  [[[
                    return states['input_select.hemma_thermostat_mode']?.state || 'cool';
                  ]]]

            hold_action:
              action: call-service
              service: input_select.select_option
              data:
                entity_id: input_select.hemma_thermostat_mode
                option: |
                  [[[
                    const sel = states['input_select.hemma_thermostat_mode']?.state || 'cool';
                    return sel === 'heat' ? 'cool' : 'heat';
                  ]]]

            styles:
              card:
                - height: 100%
                - min-height: 0
                - padding: 0
                - box-shadow: none !important
                - background: |
                    [[[
                      return ['cool','heat'].includes(entity.state)
                        ? 'var(--hemma-control-on)'
                        : 'var(--hemma-control-off)';
                    ]]]
              img_cell: [ { width: '35%' } ]
              icon: [ { width: '100%' }, { height: '100%' } ]

    target_temperature:
      card:
        type: custom:button-card
        template: [hemma_entity]
        entity: '[[[ return entity.entity_id ]]]'
        show_entity_picture: false
        show_icon: false
        name: Target Temp
        state_display: |
          [[[
            const raw = states['input_number.hemma_thermostat_target_temperature']?.state;
            const n = Math.round(Number(raw));
            if (raw == null || raw === 'unknown' || raw === 'unavailable' || Number.isNaN(n)) return '';
            return `${n}°`;
          ]]]
        tap_action:
          action: call-service
          service: input_boolean.toggle
          service_data:
            entity_id: |
              [[[
                return variables.thermostat_toggle_helper;
              ]]]

        styles:
          card:
            - background: transparent !important
            - background-color: transparent !important
            - backdrop-filter: none !important
            - animation: none !important
            - box-shadow: none !important
            - border: none !important
            - padding-right: var(--rail-w)
          icon:
            - background: transparent !important
          img_cell:
            - background: transparent !important
          custom_fields:
            temperature_controls:
              - position: absolute
              - top: 0
              - right: 0
              - bottom: 0
              - width: var(--rail-w)

        custom_fields:
          temperature_controls:
            card:
              type: custom:layout-card
              layout_type: custom:grid-layout
              layout:
                position: absolute
                inset: 0 0 0 auto
                width: var(--rail-w)
                grid-template-columns: 1fr
                grid-template-rows: repeat(3, 1fr)
                height: 100%
                margin: 0
                padding: 0
                align-items: stretch
                justify-items: stretch
              cards:
                - type: custom:button-card
                  template: [hemma_default]
                  show_entity_picture: true
                  entity_picture: /local/hemma/icons/increase.svg
                  tap_action:
                    action: call-service
                    service: input_number.increment
                    service_data:
                      entity_id: input_number.hemma_thermostat_target_temperature
                  styles:
                    card:
                      - height: 100%
                      - min-height: 0
                      - padding: 0
                      - background: var(--hemma-control-on)
                      - border-bottom: "0.5px solid rgba(255,255,255,0.1)"
                      - box-shadow: none !important
                    img_cell: [ { width: '30%' } ]
                    icon: [ { transform: 'rotate(-90deg)' } ]

                - type: custom:button-card
                  template: [hemma_default]
                  name: SET
                  tap_action:
                    action: call-service
                    service: climate.set_temperature
                    service_data:
                      entity_id: '[[[ return entity.entity_id ]]]'
                      temperature: |
                        [[[
                          const st = states['input_number.hemma_thermostat_target_temperature'];
                          const n = parseFloat(st?.state);
                          return Number.isFinite(n) ? n : null;
                        ]]]
                  styles:
                    card:
                      - height: 100%
                      - min-height: 0
                      - padding: 0
                      - background: var(--hemma-control-on)
                      - box-shadow: none !important
                      - border-bottom: "0.5px solid rgba(255,255,255,0.1)"
                    name:
                      - font-size: 10px
                      - letter-spacing: 2px
                      - text-transform: uppercase
                      - font-weight: 600

                - type: custom:button-card
                  template: [hemma_default]
                  show_entity_picture: true
                  entity_picture: /local/hemma/icons/decrease.svg
                  tap_action:
                    action: call-service
                    service: input_number.decrement
                    service_data:
                      entity_id: input_number.hemma_thermostat_target_temperature
                  styles:
                    card:
                      - height: 100%
                      - min-height: 0
                      - padding: 0
                      - box-shadow: none !important
                      - background: var(--hemma-control-on)
                    img_cell: [ { width: '30%' } ]
                    icon: [ { transform: 'rotate(-90deg)' } ]

  styles:
    card:
      - --rail-w: |
          [[[
            const isMobile = window.matchMedia('(max-width: 767px), (max-height: 600px)').matches;
            return isMobile ? '48px' : '60px';
          ]]]
    name:
      - opacity: |
          [[[
            const on = states[variables.thermostat_toggle_helper]?.state === "on";
            return on ? "0" : "1";
          ]]]
      - transition: opacity 0.25s
    state:
      - opacity: |
          [[[
            const on = states[variables.thermostat_toggle_helper]?.state === "on";
            return on ? "0" : "0.85";
          ]]]
      - transition: opacity 0.25s

    custom_fields:
      temp_puck:
        - position: absolute
        - top: var(--hemma-entity-inner-pad-current, 16px)
        - left: var(--hemma-entity-inner-pad-current, 16px)
        - width: var(--hemma-temp-puck-size, 44px)
        - height: var(--hemma-temp-puck-size, 44px)
        - z-index: 4
        - pointer-events: auto
        - '--mdc-ripple-color': transparent
        - '--paper-item-icon-active-color': transparent

      cooling_modes:
        - position: absolute
        - top: 0
        - right: 0
        - bottom: 0
        - width: var(--rail-w)
        - z-index: 2
        - pointer-events: auto
        - display: |
            [[[
              const on = states[variables.thermostat_toggle_helper]?.state === "on";
              return on ? "none" : "block";
            ]]]

      target_temperature:
        - position: absolute
        - inset: 0
        - z-index: 3
        - pointer-events: auto
        - display: |
            [[[
              const on = states[variables.thermostat_toggle_helper]?.state === "on";
              return on ? "block" : "none";
            ]]]
