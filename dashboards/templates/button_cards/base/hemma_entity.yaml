hemma_entity:
  template:
    - hemma_default
  class: hemma-entity
  show_state: true
  show_entity_picture: true
  show_icon: false

  triggers_update:
    - '[[[ return variables.battery_entity || "" ]]]'

  variables:
    battery_entity: null
    battery_low_threshold: 20

  extra_styles: |
    #battery{
      opacity: 0;
      transform: scale(.92);
      transition: opacity .8s ease, transform .3s ease;
      will-change: opacity, transform;
    }

    @media (hover: hover) and (pointer: fine){
      :host(:hover) #battery,
      :host(:focus-within) #battery{
        opacity: .6;
        transform: scale(1);
      }
    }

    @media (hover: none) and (pointer: coarse){
      #battery{ opacity: 0; }
    }


  custom_fields:
    battery: |
      [[[
        const batt = variables.battery_entity;
        if (!batt) return "";
        const st = states[batt];
        if (!st) return "";
        const raw = (st.state ?? "").toString().toLowerCase();
        const isLowWord = ["low", "critical"].includes(raw);
        const n = parseFloat(raw);
        const hasNum = Number.isFinite(n);
        const threshold = Number(variables.battery_low_threshold ?? 20);
        const isLowNum = hasNum && n <= threshold;
        if (!(isLowWord || isLowNum)) return "";
        const size = (window.innerWidth <= 768) ? 20 : 24;
        return `
          <ha-icon
            icon="mdi:battery-alert"
            style="
              --mdc-icon-size:${size}px;
              color: var(--hemma-entity-inactive, var(--secondary-text-color));
              opacity: .7;
            "
          ></ha-icon>
        `;
      ]]]

  entity_picture: |
    [[[
      const icon = variables.icon || "default";
      return `/local/hemma/icons/${icon}.svg`;
    ]]]

  state_display: |
    [[[
      if (!entity.state) return "";
      if (entity.state === "ok") return "Healthy";
      return entity.state.charAt(0).toUpperCase() + entity.state.slice(1);
    ]]]

  state:
    - operator: template
      value: |
        [[[
          const s = (entity?.state || "").toLowerCase();
          return ["on","playing","unlocked","cleaning","cool","heat"].includes(s);
        ]]]
      styles:
        card:
          - background: var(--ha-card-background-active)
          - box-shadow: var(--button-card-box-shadow-active, var(--button-card-box-shadow)) !important
        name:
          - color: var(--hemma-entity-active, var(--primary-text-color))
        state:
          - color: var(--secondary-text-color)
        icon:
          - color: var(--hemma-entity-active, var(--primary-text-color))
        img_cell:
          - opacity: var(--hemma-entity-picture-active-opacity, 1) !important
          - filter: var(--hemma-entity-picture-active-filter, none) !important
        entity_picture:
          - opacity: var(--hemma-entity-picture-active-opacity, 1) !important
          - filter: var(--hemma-entity-picture-active-filter, none) !important

  styles:
    card:
      - background: var(--ha-card-background)
      - backdrop-filter: blur(14px)
      - border-radius: var(--ha-card-border-radius, 30px)
      - position: relative
      - height: |
          [[[
            const isMobile = window.innerWidth <= 768;
            return isMobile
              ? 'var(--hemma-entity-height-mobile, 120px)'
              : 'var(--hemma-entity-height-desktop, 180px)';
          ]]]
      - padding: |
          [[[
            return (window.innerWidth <= 768)
              ? 'var(--hemma-entity-inner-pad-mobile, 18px)'
              : 'var(--hemma-entity-inner-pad-desktop, 22px)';
          ]]]
      - padding-top: |
          [[[
            return (window.innerWidth <= 768)
              ? 'var(--hemma-entity-inner-pad-mobile, 18px)'
              : 'var(--hemma-entity-inner-pad-desktop, 22px)';
          ]]]
      - scroll-snap-align: start
      - display: |
          [[[
            return (states['input_boolean.hemma_mobile_navigation'].state === 'on') ? 'none' : 'block';
          ]]]
      - --ha-card-border-width: 0
      - transition: background-color .22s ease,
                    box-shadow .24s ease,
                    transform .14s ease,
                    filter .18s ease

    custom_fields:
      battery:
        - position: absolute
        - top: 24px
        - right: 22px
        - line-height: 0
        - z-index: 3
        - pointer-events: none
        - filter: drop-shadow(0 2px 6px rgba(0,0,0,.25))

    name:
      - color: var(--hemma-entity-inactive, var(--secondary-text-color)) !important
      - font-weight: 600
      - text-shadow: var(--hemma-entity-text-shadow, 0 0 3px rgba(0, 0, 0, 0.3))
      - justify-self: start
      - margin-bottom: 0px
      - font-size: |
          [[[
            const isMobile = window.innerWidth <= 768;
            return isMobile
              ? 'var(--hemma-entity-name-font-mobile, 15px)'
              : 'var(--hemma-entity-name-font-desktop, 16px)';
          ]]]
      - line-height: 1.15
      - white-space: nowrap
      - overflow: hidden
      - text-overflow: ellipsis
      - transition: color .18s ease, opacity .18s ease

    state:
      - text-transform: capitalize
      - color: var(--hemma-entity-inactive, var(--secondary-text-color)) !important
      - font-size: |
          [[[
            const isMobile = window.innerWidth <= 768;
            return isMobile
              ? 'var(--hemma-entity-state-font-mobile, 13px)'
              : 'var(--hemma-entity-state-font-desktop, 14px)';
          ]]]
      - text-shadow: var(--hemma-entity-text-shadow, 0 0 3px rgba(0, 0, 0, 0.3))
      - justify-self: start
      - font-weight: 700
      - opacity: 0.75
      - line-height: 1.15
      - transition: color .18s ease, opacity .18s ease

    grid:
      - grid-template-columns: 1fr
      - grid-template-rows: 1fr min-content min-content
      - grid-template-areas: |
          "i"
          "n"
          "s"
      - row-gap: 4px
      - justify-items: start
      - align-items: start

    img_cell:
      - justify-self: start
      - align-self: start
      - color: var(--hemma-entity-inactive, var(--secondary-text-color)) !important
      - width: |
          [[[
            return (window.innerWidth <= 768)
              ? 'var(--hemma-entity-icon-size-mobile, 26px)'
              : 'var(--hemma-entity-icon-size-desktop, 30px)';
          ]]]
      - height: |
          [[[
            return (window.innerWidth <= 768)
              ? 'var(--hemma-entity-icon-size-mobile, 26px)'
              : 'var(--hemma-entity-icon-size-desktop, 30px)';
          ]]]
      - background: transparent
      - transition: opacity .18s ease, filter .18s ease

    entity_picture:
      - opacity: var(--hemma-entity-picture-inactive-opacity, .9)
      - filter: var(--hemma-entity-picture-inactive-filter, brightness(.9))
      - transition: opacity .18s ease, filter .18s ease

    icon:
      - color: var(--hemma-entity-inactive, var(--secondary-text-color)) !important
      - width: 100%
      - height: 100%
